rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {

    // ========= HELPERS BÁSICOS (USANDO CLAIMS) =========
    function isSignedIn() {
      return request.auth != null;
    }

    function userRole() {
      return isSignedIn() ? request.auth.token.role : null;
    }

    function userStatus() {
      return isSignedIn() ? request.auth.token.status : null;
    }

    function isApprovedUser() {
      return isSignedIn() && userStatus() == 'aprovado';
    }

    function isAdmin()       { return userRole() == 'administrador'; }
    function isCoordinator() { return userRole() == 'coordenador'; }
    function isProfessor()   { return userRole() == 'professor'; }

    function isProfessorOrAbove() {
      return isApprovedUser() && (isProfessor() || isCoordinator() || isAdmin());
    }

    function isCoordinatorOrAdmin() {
      return isApprovedUser() && (isCoordinator() || isAdmin());
    }

    // ===================== AVATARES =====================
    // avatars/{userId}/{fileName}
    match /avatars/{userId}/{fileName} {
      allow read: if isApprovedUser();
      allow write: if isApprovedUser() && request.auth.uid == userId;
    }

    // ================== MATERIAIS DE AULA ==================
    // materiais/aula/{lessonId}/{fileName}
    match /materiais/aula/{lessonId}/{fileName} {
      // leitura para qualquer usuário aprovado (aluno, professor, coord, admin)
      allow read: if isApprovedUser();

      // escrita apenas para professor/coordenador/admin aprovados
      allow write: if isProfessorOrAbove();
    }

    // ================== MATERIAIS GERAIS (opcional) ==================
    // materiais/geral/{fileName}
    match /materiais/geral/{fileName} {
      allow read: if isApprovedUser();
      allow write: if isProfessorOrAbove();
    }

    // ======================== FALLBACK ========================
    match /{path=**} {
      allow read: if isApprovedUser();
      allow write: if isCoordinatorOrAdmin();
    }
  }
}
