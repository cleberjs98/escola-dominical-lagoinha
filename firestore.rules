rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helpers
    function isSignedIn() {
      return request.auth != null;
    }
    function roleFromToken() {
      return isSignedIn() ? (request.auth.token.role != null ? request.auth.token.role : null) : null;
    }
    function roleFromDoc(uid) {
      return isSignedIn() ? get(/databases/$(database)/documents/users/$(uid)).data.papel : null;
    }
    function requestUserRole() {
      return roleFromToken() != null ? roleFromToken() : roleFromDoc(request.auth.uid);
    }
    function isAdmin()       { return requestUserRole() == 'administrador'; }
    function isCoordinator() { return requestUserRole() == 'coordenador'; }
    function isProfessor()   { return requestUserRole() == 'professor'; }
    function isApprovedUser() {
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.status == 'aprovado';
    }

    // Users
    match /users/{userId} {
      function isSelf() { return isSignedIn() && request.auth.uid == userId; }
      allow get: if isSelf() || isCoordinator() || isAdmin();
      allow list: if isCoordinator() || isAdmin();
      allow create: if isSelf() || isAdmin();
      allow update: if isSelf() || isAdmin() || (isCoordinator() && resource.data.papel != 'administrador');
      allow delete: if isAdmin() && request.auth.uid != userId;
    }

    // Aulas
    match /aulas/{id} {
      allow get, list: if (resource.data.status == 'publicada') || isProfessor() || isCoordinator() || isAdmin();
      allow create, update: if isCoordinator() || isAdmin();
      allow delete: if isAdmin();
    }

    // Reservas de aula
    match /reservas_aula/{id} {
      allow create: if isProfessor() && request.resource.data.professor_id == request.auth.uid;
      allow get, list: if isAdmin() || isCoordinator() ||
        (isProfessor() && (
          (request.resource != null && request.resource.data.professor_id == request.auth.uid) ||
          (resource != null && resource.data.professor_id == request.auth.uid)
        ));
      allow update: if isAdmin() || isCoordinator();
      allow delete: if false;
    }

    // Devocionais
    match /devocionais/{id} {
      allow get, list: if isApprovedUser() && resource.data.status == 'publicado';
      allow create, update, delete: if isCoordinator() || isAdmin();
    }

    // Noticias
    match /noticias/{id} {
      allow get, list: if isApprovedUser() && resource.data.status == 'publicada';
      allow create: if (isProfessor() || isCoordinator() || isAdmin()) &&
        request.resource.data.autor_id == request.auth.uid;
      allow update: if (isProfessor() && resource.data.autor_id == request.auth.uid) || isCoordinator() || isAdmin();
      allow delete: if isCoordinator() || isAdmin();
    }

    // Materiais de apoio
    match /materiais_apoio/{id} {
      allow get, list: if isApprovedUser();
      allow create: if isProfessor() || isCoordinator() || isAdmin();
      allow update: if (isProfessor() && resource.data.enviado_por_id == request.auth.uid) || isCoordinator() || isAdmin();
      allow delete: if (isProfessor() && resource.data.enviado_por_id == request.auth.uid) || isCoordinator() || isAdmin();
    }

    // Notificacoes
    match /notificacoes/{id} {
      allow get, list: if isSignedIn() && request.auth.uid == resource.data.usuario_id;
      allow create: if isSignedIn() &&
        (
          request.resource.data.usuario_id == request.auth.uid ||
          isCoordinator() ||
          isAdmin()
        );
      allow update: if
        (isSignedIn() &&
          resource.data.usuario_id == request.auth.uid &&
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['lida', 'lida_em']) &&
          request.resource.data.usuario_id == resource.data.usuario_id) ||
        isCoordinator() ||
        isAdmin();
      allow delete: if isAdmin();
    }

    // Theme settings - apenas administradores
    match /theme_settings/{id} {
      allow get, list: if isAdmin();
      allow create, update, delete: if isAdmin();
    }

    // Layout settings - apenas administradores
    match /layout_settings/{id} {
      allow get, list: if isAdmin();
      allow create, update, delete: if isAdmin();
    }

    // Backgrounds - apenas administradores
    match /backgrounds/{id} {
      allow get, list: if isAdmin();
      allow create, update, delete: if isAdmin();
    }

    // Navigation tabs - apenas administradores
    match /navigation_tabs/{id} {
      allow get, list: if isAdmin();
      allow create, update, delete: if isAdmin();
    }

    // Screen layouts - apenas administradores
    match /screen_layouts/{id} {
      allow get, list: if isAdmin();
      allow create, update, delete: if isAdmin();
    }
  }
}
